# –õ–∏–º–∏—Ç—ã –∏ –ë—ç–∫–∞–ø—ã

## üìä –õ–∏–º–∏—Ç—ã –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á

### Rate Limiting: 10 –∑–∞–¥–∞—á –∑–∞ 10 –º–∏–Ω—É—Ç

–°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞ –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏:

- **–ú–∞–∫—Å–∏–º—É–º**: 10 –Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –∑–∞ 10 –º–∏–Ω—É—Ç –Ω–∞ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **–•—Ä–∞–Ω–∏–ª–∏—â–µ**: –¢–∞–±–ª–∏—Ü–∞ `task_creation_rate_limit`
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ —É–¥–∞–ª—è—é—Ç—Å—è –∑–∞–ø–∏—Å–∏ —Å—Ç–∞—Ä—à–µ 1 –¥–Ω—è (1:00 UTC)
- **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ `handlers/tasks/constructor.py`

#### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É"
2. –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –º–∏–Ω—É—Ç
3. –ï—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
4. –ò–Ω–∞—á–µ, —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è (–µ—Å–ª–∏ –Ω–µ –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç —Ç–∞—Ä–∏—Ñ–∞)

#### –§—É–Ω–∫—Ü–∏–∏ –≤ `database/rate_limit.py`:

```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç
rate_limit = check_task_creation_rate_limit(user_id)
# –í–µ—Ä–Ω–µ—Ç: {'allowed': bool, 'current_count': int, 'remaining': int, 'reset_at': datetime}

# –ó–∞–ø–∏—Å–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ
record_task_creation(user_id)

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏
cleanup_old_rate_limit_records(days=1)
```

### –õ–∏–º–∏—Ç—ã –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º

–ü–æ–º–∏–º–æ rate limiting, –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ª–∏–º–∏—Ç—ã —Ç–∞—Ä–∏—Ñ–∞:

| –¢–∞—Ä–∏—Ñ   | –ú–∞–∫—Å–∏–º—É–º –∑–∞–¥–∞—á | –ú–∞–∫—Å–∏–º—É–º –∫–∞–Ω–∞–ª–æ–≤ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ       |
| ------- | -------------- | ---------------- | ---------------- |
| free    | 5              | 1                | –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω  |
| pro     | 20             | 5                | –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π |
| premium | 100            | 20               | –ü—Ä–µ–º–∏—É–º          |

–§—É–Ω–∫—Ü–∏—è: `get_tariff_limits(tariff_name)` –≤ `models/tariff.py`

## üíæ –ë—ç–∫–∞–ø—ã –ë–î

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã

**–ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 02:00 UTC** —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å–∂–∞—Ç—ã–π –±—ç–∫–∞–ø –≤—Å–µ–π –ë–î PostgreSQL.

#### –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:

- **–§–æ—Ä–º–∞—Ç**: SQL (—Å–∂–∞—Ç—ã–π gzip)
- **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `./backups/` (–Ω–∞ —Ö–æ—Å—Ç–µ)
- **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ**: `xsb_db_backup_YYYYMMDD_HHMMSS.sql.gz`
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: 7 –¥–Ω–µ–π (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `BACKUP_RETENTION_DAYS`)
- **–†–∞–∑–º–µ—Ä**: –û–±—ã—á–Ω–æ 5-50 –ú–ë –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö

#### –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤ Docker:

```
Host: /Users/leofillium/PycharmProjects/xsb-duplicate/backups/
Docker volume: backups:/backups
```

### –°–∫—Ä–∏–ø—Ç—ã –±—ç–∫–∞–ø–æ–≤

#### 1. Python —Å–∫—Ä–∏–ø—Ç: `scripts/backup_db.py`

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:

```bash
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –±—ç–∫–∞–ø
python scripts/backup_db.py backup

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
python scripts/backup_db.py cleanup

# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤
python scripts/backup_db.py list

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞
python scripts/backup_db.py restore --file backups/xsb_db_backup_20251204_020000.sql.gz
```

#### 2. Bash —Å–∫—Ä–∏–ø—Ç: `scripts/backup_runner.sh`

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è cron –∑–∞–¥–∞—á –Ω–∞ —Ö–æ—Å—Ç–µ:

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –≤ 02:00
0 2 * * * /path/to/xsb-duplicate/scripts/backup_runner.sh

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
tail -f ./backups/backup.log
```

### –ö–æ–º–∞–Ω–¥—ã Docker Compose –¥–ª—è –±—ç–∫–∞–ø–æ–≤

```bash
# –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ (—á–µ—Ä–µ–∑ Python —Å–∫—Ä–∏–ø—Ç)
docker-compose exec bot python scripts/backup_db.py backup

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±—ç–∫–∞–ø–æ–≤
docker-compose exec bot python scripts/backup_db.py list

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞
docker-compose exec bot python scripts/backup_db.py restore --file backups/xsb_db_backup_20251204_020000.sql.gz

# –ü—Ä—è–º–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ —á–µ—Ä–µ–∑ pg_dump (–±–µ–∑ —Å–∂–∞—Ç–∏—è)
docker-compose exec -T db pg_dump -U postgres xsb_db > backups/manual_backup.sql

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ä–∞–∑—É –∏–∑ pg_dump
docker-compose exec -T db psql -U postgres -d xsb_db < backups/manual_backup.sql
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –±—ç–∫–∞–ø–æ–≤

```env
# .env —Ñ–∞–π–ª
BACKUP_RETENTION_DAYS=7
BACKUP_COMPRESSION=true
```

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤

#### –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –≤ –≥–ª–∞–≤–Ω–æ–º –±–æ—Ç–µ:

```python
# main.py - Scheduler jobs

# 00:00 UTC - –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
cleanup_inactive_tasks

# 00:05 UTC - –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ—à–ª—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
cleanup_past_schedules

# 01:00 UTC - –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö rate limit –∑–∞–ø–∏—Å–µ–π
cleanup_rate_limit_records

# 02:00 UTC - –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ –ë–î (–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ docker-compose –∏–ª–∏ cron)
backup_db
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—ç–∫–∞–ø–æ–≤**

   - –•—Ä–∞–Ω–∏—Ç—å –±—ç–∫–∞–ø—ã –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (AWS S3, Google Cloud Storage)
   - –®–∏—Ñ—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –±—ç–∫–∞–ø—ã

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**

   - –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞
   - –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –±—ç–∫–∞–ø–∞
   - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

3. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**
   - –†–µ–≥—É–ª—è—Ä–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
   - –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
   - –ò–º–µ—Ç—å –ø–ª–∞–Ω –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –∞–≤–∞—Ä–∏–∏

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–≥—É–ª—è—Ä–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
# –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 02:00 —Å–æ–∑–¥–∞–≤–∞—Ç—å –±—ç–∫–∞–ø
0 2 * * * cd /path/to/xsb-duplicate && ./scripts/backup_runner.sh

# –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ 03:00 –∑–∞–≥—Ä—É–∂–∞—Ç—å –≤ –æ–±–ª–∞–∫–æ
0 3 * * 1 cd /path/to/xsb-duplicate && rclone copy backups/ s3://my-bucket/xsb-backups/
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
docker-compose stop bot

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î –∏–∑ –±—ç–∫–∞–ø–∞
docker-compose exec -T db psql -U postgres xsb_db < backups/xsb_db_backup_20251204_020000.sql

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
docker-compose start bot

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs -f bot
```

#### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä

```bash
# –ù–∞ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
docker-compose exec -T db pg_dump -U postgres xsb_db > xsb_db_backup.sql

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –Ω–∞ –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä
scp xsb_db_backup.sql newserver:/path/to/xsb-duplicate/

# –ù–∞ –Ω–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
docker-compose down -v  # –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
docker-compose up -d db  # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ –ë–î
docker-compose exec -T db psql -U postgres xsb_db < xsb_db_backup.sql
docker-compose up -d  # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
```

## üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ë–î

### –ò–Ω–¥–µ–∫—Å—ã

–°–æ–∑–¥–∞–Ω–æ 28+ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:

```sql
-- –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
idx_rate_limit_user_time    -- Rate limiting queries
idx_jobs_status             -- Publication job queries
idx_tasks_user_id           -- User task queries
idx_task_schedules_task_id  -- Schedule queries
```

### –¢—Ä–∏–≥–≥–µ—Ä—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
- –ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### –ê—Ä—Ö–∏–≤ –∑–∞–¥–∞—á

- **–¢–∞–±–ª–∏—Ü–∞**: `tasks_archive`
- **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞**: 65+ –¥–Ω–µ–π
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ë–î

```bash
# –ß–µ—Ä–µ–∑ docker-compose
docker-compose exec -T db psql -U postgres -d xsb_db -c \
  "SELECT pg_size_pretty(pg_database_size('xsb_db')) AS size;"
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—ç–∫–∞–ø–æ–≤

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞
ls -lh backups/ | tail -20

# –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö –±—ç–∫–∞–ø–æ–≤
du -sh backups/
```

### –õ–æ–≥–∏ –±—ç–∫–∞–ø–æ–≤

```bash
# –ß–∏—Ç–∞—Ç—å –ª–æ–≥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –±—ç–∫–∞–ø–æ–≤
tail -50 backups/backup.log

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
grep ERROR backups/backup.log
```
